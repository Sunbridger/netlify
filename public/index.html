<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Netlify CRUD 演示</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Netlify CRUD 演示</h1>
        <p class="subtitle">使用 Netlify Functions 和本地 JSON 存储实现</p>
      </header>

      <div id="alert" class="alert"></div>

      <div class="card">
        <h2>添加/编辑项目</h2>
        <form id="itemForm">
          <input type="hidden" id="itemId" />
          <div class="form-group">
            <label for="name">名称</label>
            <input type="text" id="name" placeholder="输入项目名称" required />
          </div>
          <div class="form-group">
            <label for="description">描述</label>
            <textarea
              id="description"
              placeholder="输入项目描述"
              required
            ></textarea>
          </div>
          <button type="submit" id="submitBtn" class="btn">添加项目</button>
          <button
            type="button"
            id="cancelBtn"
            class="btn btn-danger"
            style="display: none; margin-left: 10px"
          >
            取消编辑
          </button>
        </form>
      </div>

      <div class="card">
        <h2>项目列表</h2>
        <div id="loading" class="loading">
          <div class="spinner"></div>
          <p>加载中...</p>
        </div>
        <div id="itemsList" class="items-list">
          <!-- 项目列表将通过JavaScript动态生成 -->
        </div>
      </div>
    </div>

    <script>
      // API 基础路径
      const API_BASE = '/.netlify/functions';

      // DOM 元素
      const itemForm = document.getElementById('itemForm');
      const nameInput = document.getElementById('name');
      const descriptionInput = document.getElementById('description');
      const itemIdInput = document.getElementById('itemId');
      const submitBtn = document.getElementById('submitBtn');
      const cancelBtn = document.getElementById('cancelBtn');
      const itemsList = document.getElementById('itemsList');
      const loading = document.getElementById('loading');
      const alertBox = document.getElementById('alert');

      // 当前编辑状态
      let isEditing = false;

      // 显示提示信息
      function showAlert(message, type = 'success') {
        alertBox.textContent = message;
        alertBox.className = `alert alert-${type}`;
        alertBox.style.display = 'block';

        setTimeout(() => {
          alertBox.style.display = 'none';
        }, 3000);
      }

      // 显示加载状态
      function showLoading(show) {
        loading.style.display = show ? 'block' : 'none';
        itemsList.style.display = show ? 'none' : 'grid';
      }

      // 获取所有项目
      async function fetchItems() {
        showLoading(true);
        try {
          const response = await fetch(`${API_BASE}/get-items`);
          if (!response.ok) throw new Error('获取数据失败');
          return await response.json();
        } catch (error) {
          console.error('Error:', error);
          showAlert('获取项目列表失败: ' + error.message, 'error');
          return [];
        } finally {
          showLoading(false);
        }
      }

      // 获取单个项目
      async function fetchItem(id) {
        try {
          const response = await fetch(`${API_BASE}/get-item/${id}`);
          if (!response.ok) throw new Error('获取数据失败');
          return await response.json();
        } catch (error) {
          console.error('Error:', error);
          showAlert('获取项目详情失败: ' + error.message, 'error');
          return null;
        }
      }

      // 创建项目
      async function createItem(item) {
        try {
          const response = await fetch(`${API_BASE}/create-item`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(item),
          });
          const data = await response.json();
          showAlert('项目创建成功');
          return data;
        } catch (error) {
          console.error('Error:', error);
          showAlert('创建项目失败: ' + error.message, 'error');
          return null;
        }
      }

      // 更新项目
      async function updateItem(id, updates) {
        try {
          const response = await fetch(`${API_BASE}/update-item/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updates),
          });
          const data = await response.json();
          showAlert('项目更新成功');
          return data;
        } catch (error) {
          console.error('Error:', error);
          showAlert('更新项目失败: ' + error.message, 'error');
          return null;
        }
      }

      // 删除项目
      async function deleteItem(id) {
        try {
          const response = await fetch(`${API_BASE}/delete-item/${id}`, {
            method: 'DELETE',
          });
          const data = await response.json();
          showAlert('项目删除成功');
          return data;
        } catch (error) {
          console.error('Error:', error);
          showAlert('删除项目失败: ' + error.message, 'error');
          return null;
        }
      }

      // 渲染项目列表
      async function renderItems() {
        const items = await fetchItems();
        itemsList.innerHTML = '';

        if (items.length === 0) {
          itemsList.innerHTML =
            '<p style="grid-column: 1 / -1; text-align: center;">没有项目，请添加一个新项目</p>';
          return;
        }

        items.forEach((item) => {
          const itemElement = document.createElement('div');
          itemElement.className = 'item-card';
          itemElement.innerHTML = `
          <h3 class="item-title">${item.name}</h3>
          <p class="item-description">${item.description}</p>
          <div class="item-actions">
            <button class="btn btn-sm edit-btn" data-id="${item.id}">编辑</button>
            <button class="btn btn-sm btn-danger delete-btn" data-id="${item.id}">删除</button>
          </div>
        `;
          itemsList.appendChild(itemElement);
        });

        // 添加删除按钮事件
        document.querySelectorAll('.delete-btn').forEach((btn) => {
          btn.addEventListener('click', async (e) => {
            if (confirm('确定要删除这个项目吗？')) {
              const id = parseInt(e.target.dataset.id);
              await deleteItem(id);
              await renderItems();
            }
          });
        });

        // 添加编辑按钮事件
        document.querySelectorAll('.edit-btn').forEach((btn) => {
          btn.addEventListener('click', async (e) => {
            const id = parseInt(e.target.dataset.id);
            const item = await fetchItem(id);

            if (item) {
              isEditing = true;
              itemIdInput.value = item.id;
              nameInput.value = item.name;
              descriptionInput.value = item.description;
              submitBtn.textContent = '更新项目';
              cancelBtn.style.display = 'inline-block';

              // 滚动到表单
              itemForm.scrollIntoView({ behavior: 'smooth' });
            }
          });
        });
      }

      // 表单提交处理
      itemForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const name = nameInput.value.trim();
        const description = descriptionInput.value.trim();

        if (!name || !description) {
          showAlert('请填写所有字段', 'error');
          return;
        }

        const item = { name, description };

        if (isEditing) {
          const id = parseInt(itemIdInput.value);
          await updateItem(id, item);
        } else {
          await createItem(item);
        }

        // 重置表单
        itemForm.reset();
        itemIdInput.value = '';
        isEditing = false;
        submitBtn.textContent = '添加项目';
        cancelBtn.style.display = 'none';

        // 刷新列表
        await renderItems();
      });

      // 取消编辑
      cancelBtn.addEventListener('click', () => {
        itemForm.reset();
        itemIdInput.value = '';
        isEditing = false;
        submitBtn.textContent = '添加项目';
        cancelBtn.style.display = 'none';
      });

      // 初始化
      document.addEventListener('DOMContentLoaded', renderItems);
    </script>
  </body>
</html>
