<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Netlify CRUD Demo</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <h1>Netlify CRUD Demo</h1>

      <div class="form-section">
        <h2>添加新项目</h2>
        <form id="createForm">
          <input type="text" id="name" placeholder="名称" required />
          <input type="text" id="description" placeholder="描述" required />
          <button type="submit">添加</button>
        </form>
      </div>

      <div class="list-section">
        <h2>项目列表</h2>
        <div id="itemsList"></div>
      </div>
    </div>

    <script>
      // 更新 API 基础路径
      const API_BASE = '/.netlify/functions';

      // 获取所有项目
      async function fetchItems() {
        try {
          const response = await fetch(`${API_BASE}/get-items`);
          if (!response.ok) throw new Error('获取数据失败');
          return await response.json();
        } catch (error) {
          console.error('Error:', error);
          return [];
        }
      }

      // 获取单个项目
      async function fetchItem(id) {
        try {
          const response = await fetch(`${API_BASE}/get-item/${id}`);
          if (!response.ok) throw new Error('获取数据失败');
          return await response.json();
        } catch (error) {
          console.error('Error:', error);
          return null;
        }
      }

      // 创建项目
      async function createItem(item) {
        try {
          const response = await fetch(`${API_BASE}/create-item`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(item),
          });
          return await response.json();
        } catch (error) {
          console.error('Error:', error);
          return null;
        }
      }

      // 更新项目
      async function updateItem(id, updates) {
        try {
          const response = await fetch(`${API_BASE}/update-item/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updates),
          });
          return await response.json();
        } catch (error) {
          console.error('Error:', error);
          return null;
        }
      }

      // 删除项目
      async function deleteItem(id) {
        try {
          const response = await fetch(`${API_BASE}/delete-item/${id}`, {
            method: 'DELETE',
          });
          return await response.json();
        } catch (error) {
          console.error('Error:', error);
          return null;
        }
      }
      // 表单提交处理
      document
        .getElementById('createForm')
        .addEventListener('submit', async (e) => {
          e.preventDefault();

          const form = e.target;
          const name = document.getElementById('name').value;
          const description = document.getElementById('description').value;

          if (form.dataset.editing) {
            // 更新现有项目
            const id = parseInt(form.dataset.editing);
            await updateItem(id, { name, description });
            delete form.dataset.editing;
          } else {
            // 创建新项目
            await createItem({ name, description });
          }

          form.reset();
          await renderItems();
        });

      // 初始化
      document.addEventListener('DOMContentLoaded', renderItems);
    </script>
  </body>
</html>
